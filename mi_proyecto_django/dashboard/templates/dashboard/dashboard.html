{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Dashboard de Humedad</title>
    <link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
    <div class="dashboard-container">
        <!-- Primera fila: estadísticas principales -->
        <div class="stats-row">
            <div class="stat-card">
                <h2>Máxima del Día</h2>
                <div class="value" id="max-humedad">--</div>
                <div class="label">%</div>
            </div>
            <div class="stat-card">
                <h2>Mínima del Día</h2>
                <div class="value" id="min-humedad">--</div>
                <div class="label">%</div>
            </div>
            <div class="stat-card">
                <h2>Promedio del Día</h2>
                <div class="value" id="avg-humedad">--</div>
                <div class="label">%</div>
            </div>
            <div class="stat-card">
                <h2>Valor Actual</h2>
                <div class="value" id="valor-actual">--</div>
                <div class="label">%</div>
            </div>
        </div>

        <!-- Segunda fila: indicadores extra -->
        <div class="indicators-row">
            <div class="indicador-extra">
                <b>Estado Sensor:</b> <span id="estado_sensor">--</span>
            </div>
            <div class="indicador-extra">
                <b>Semáforo:</b> <span id="semaforo"></span>
            </div>
            <div class="indicador-extra">
                <b>Tiempo desde último crítico:</b> <span id="tiempo_critico">--</span> s
            </div>
        </div>

        <!-- Tercera fila: navegación gráfica/datos -->
        <div class="controls-row">
            <button id="btnGrafico" class="btn-toggle active">Gráfico</button>
            <button id="btnData" class="btn-toggle">Data Histórica</button>
        </div>

        <!-- Contenido dinámico -->
        <div class="content-section">
            <div id="graficoContent">
                <h2>Gráfico de Humedad</h2>
                <canvas id="graficoEvolucion"></canvas>
            </div>
            <div id="dataContent" class="hidden">
                <h2>Data Histórica de Humedad</h2>
                <div id="historial"></div>
                <button class="btn-historial" onclick="mostrarHistorial()">Buscar por fecha</button>
            </div>
        </div>
    </div>

    <script>
        // Estadísticas e indicadores
        function cargarEstadisticas() {
            axios.get("{% url 'estadisticas_humedad' %}")
                .then(response => {
                    const { maximo, minimo, promedio, actual } = response.data;
                    document.getElementById('max-humedad').textContent = maximo?.toFixed(1) ?? '--';
                    document.getElementById('min-humedad').textContent = minimo?.toFixed(1) ?? '--';
                    document.getElementById('avg-humedad').textContent = promedio?.toFixed(1) ?? '--';
                    document.getElementById('valor-actual').textContent = actual?.toFixed(1) ?? '--';
                    actualizarSemaforo(actual ?? 0);
                })
                .catch(error => console.error("Error al cargar estadísticas:", error));

            axios.get("{% url 'estado_sensor' %}")
                .then(response => {
                    document.getElementById('estado_sensor').textContent = response.data.conectado ? "Conectado" : "Desconectado";
                });

            axios.get("{% url 'tiempo_desde_ultimo_critico' %}")
                .then(response => {
                    document.getElementById('tiempo_critico').textContent = response.data.segundos_desde_critico ?? '--';
                });
        }

        function actualizarSemaforo(valor) {
            let color = "green";
            if (valor > 80) color = "red";
            else if (valor > 60) color = "yellow";
            document.getElementById("semaforo").style.background = color;
        }

        // Gráfico de evolución
        const ctx = document.getElementById('graficoEvolucion').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Humedad (%)', data: [], borderColor: 'blue', fill: false }] }
        });
        function actualizarGrafico() {
            axios.get("{% url 'humedad_evolucion_json' %}")
                .then(response => {
                    const data = response.data;
                    chart.data.labels = data.map(d => d.timestamp);
                    chart.data.datasets[0].data = data.map(d => d.humedad);
                    chart.update();
                });
        }

        // Historial
        function mostrarHistorial() {
            const fecha = prompt("Ingrese fecha (YYYY-MM-DD):");
            if (!fecha) return;
            axios.get("{% url 'historial_por_dia' %}?fecha=" + fecha)
                .then(response => {
                    document.getElementById('historial').innerHTML = response.data;
                    document.getElementById('dataContent').classList.remove('hidden');
                });
        }

        // Inicialización y actualización periódica
        cargarEstadisticas();
        actualizarGrafico();
        setInterval(cargarEstadisticas, 5000);
        setInterval(actualizarGrafico, 5000);

        // Lógica de botones
        document.getElementById('btnGrafico').addEventListener('click', () => {
            document.getElementById('btnGrafico').classList.add('active');
            document.getElementById('btnData').classList.remove('active');
            document.getElementById('graficoContent').classList.remove('hidden');
            document.getElementById('dataContent').classList.add('hidden');
        });
        document.getElementById('btnData').addEventListener('click', () => {
            document.getElementById('btnData').classList.add('active');
            document.getElementById('btnGrafico').classList.remove('active');
            document.getElementById('graficoContent').classList.add('hidden');
            document.getElementById('dataContent').classList.remove('hidden');
        });
    </script>

</body>
</html>